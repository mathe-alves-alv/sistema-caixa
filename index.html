// ... (código HTML e CSS anterior)

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- LÓGICA DO SUPABASE (Revisada e Corrigida) ---
        const SUPABASE_URL = 'https://rqeqghjlbojbklmiyshp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZXFnaGpsYm9qYmtsbWl5c2hwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTQzNzYsImV4cCI6MjA3NDQ5MDM3Nn0.oQNkIPMwmcNKCB-I4Iq2GlKqazGSjxarLtfuZbvlX4o';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- LÓGICA DA APLICAÇÃO ---
        // CORRIGIDO: "NARKETING" para "MARKETING" conforme solicitação.
        const formasDePagamento = ['CONSUMO ADM', 'CORTESIA', 'CREDITO', 'DEBITO', 'DINHEIRO', 'EVENTO', 'IFOOD', 'MARKETING', 'PERDAS', 'PIX', 'PIX MANUAL', 'TRANSFERENCIA', 'VOUCHER'];
        let todosOsLancamentos = {};
        
        const dataInput = document.getElementById('data-fechamento');
        const formasPagamentoDiv = document.getElementById('formas-pagamento');
        const btnSalvar = document.getElementById('btn-salvar-caixa');
        const btnResumo = document.getElementById('btn-ver-resumo');
        const btnLimpar = document.getElementById('btn-limpar');
        const resumoDiv = document.getElementById('resumo');
        const resumoTitulo = document.getElementById('resumo-titulo');
        const resultadoFechamentoDiv = document.getElementById('resultado-fechamento');
        const listaHistoricoDiv = document.getElementById('lista-historico');

        const formatarMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const sanitizarNomeParaId = (nome) => nome.toLowerCase().replace(/ /g, '-');
        
        const atualizarTudo = (forma) => {
            const lancamentos = todosOsLancamentos[forma] || [];
            const total = lancamentos.reduce((soma, valor) => soma + valor, 0);
            const totalField = document.getElementById(`total-${sanitizarNomeParaId(forma)}`);
            if (totalField) totalField.textContent = formatarMoeda(total);

            const listaDetalheDiv = document.getElementById(`detalhe-${sanitizarNomeParaId(forma)}`);
            if(listaDetalheDiv) {
                listaDetalheDiv.innerHTML = '';
                lancamentos.forEach((valor, index) => {
                    const tag = document.createElement('div');
                    tag.className = 'lancamento-tag';
                    tag.innerHTML = `<span>${formatarMoeda(valor)}</span><button class="remove-lancamento" data-forma="${forma}" data-index="${index}">&times;</button>`;
                    listaDetalheDiv.appendChild(tag);
                });
            }
        };

        const lancarValor = (forma) => {
            const campoLancamento = document.getElementById(`lancamento-${sanitizarNomeParaId(forma)}`);
            // Pequena correção para melhor sanitização, aceitando ',' ou '.'
            const valor = parseFloat(campoLancamento.value.replace(/[^0-9,.]/g, '').replace(',', '.'));
            if (isNaN(valor) || valor === 0) { campoLancamento.value = ''; return; }
            if (!todosOsLancamentos[forma]) todosOsLancamentos[forma] = [];
            todosOsLancamentos[forma].push(valor);
            atualizarTudo(forma);
            campoLancamento.value = ''; 
            campoLancamento.focus();
        };
        
        const removerLancamento = (forma, index) => {
            const lancamentoParaRemover = todosOsLancamentos[forma][index];
            // IMPLEMENTADO: Pergunta de confirmação de exclusão, conforme nossa instrução.
            if (window.confirm(`Você realmente quer excluir o valor de ${formatarMoeda(lancamentoParaRemover)}?`)) {
                todosOsLancamentos[forma].splice(index, 1);
                atualizarTudo(forma);
            }
        };

        const gerarCamposDePagamento = () => {
            formasPagamentoDiv.innerHTML = '';
            formasDePagamento.forEach(forma => {
                const idForma = sanitizarNomeParaId(forma);
                const campoHTML = `
                    <div class="payment-item">
                        <div class="main-line">
                            <label for="lancamento-${idForma}">${forma}</label>
                            <input type="text" id="lancamento-${idForma}" class="lancamento-field" placeholder="0,00">
                            <button class="btn-lancar" data-forma="${forma}">Lançar</button>
                        </div>
                        <div class="lancamentos-detalhe" id="detalhe-${idForma}"></div>
                    </div>`;
                formasPagamentoDiv.innerHTML += campoHTML;
            });
        };
        
        const calcularEExibirResumo = () => {
            let totalGeral = 0;
            let resumoHTML = '';
            const dataSelecionada = new Date(dataInput.value + 'T00:00:00').toLocaleDateString('pt-BR');
            resumoTitulo.innerText = `Resumo do Caixa - ${dataSelecionada}`;
            formasDePagamento.sort().forEach(forma => {
                const lancamentos = todosOsLancamentos[forma] || [];
                const totalForma = lancamentos.reduce((soma, valor) => soma + valor, 0);
                if (totalForma > 0) {
                    resumoHTML += `<p>${forma}: <span>${formatarMoeda(totalForma)}</span></p>`;
                }
                totalGeral += totalForma;
            });
            resumoHTML += `<p id="total-geral">TOTAL GERAL: <span>${formatarMoeda(totalGeral)}</span></p>`;
            resultadoFechamentoDiv.innerHTML = resumoHTML;
            resumoDiv.classList.add('is-visible');
        };

        const limparTela = () => {
            if (confirm("Você tem certeza que deseja limpar todos os lançamentos da tela? Isso não afetará os dados já salvos na nuvem.")) {
                todosOsLancamentos = {};
                formasDePagamento.forEach(forma => atualizarTudo(forma));
                resumoDiv.classList.remove('is-visible');
            }
        };

        const salvarFechamento = async () => {
            // ... (lógica de salvar inalterada)
            const nomeOperador = window.prompt("Digite o nome do operador de caixa:");
            if (!nomeOperador) {
                alert("O nome do operador é obrigatório para salvar."); return;
            }
            const data = dataInput.value;
            let totalGeral = 0;
            Object.values(todosOsLancamentos).forEach(lancamentos => {
                totalGeral += lancamentos.reduce((soma, v) => soma + v, 0);
            });
            if (totalGeral === 0 && Object.keys(todosOsLancamentos).length === 0) {
                alert("Não há valores para salvar."); return;
            }
            btnSalvar.disabled = true;
            btnSalvar.innerText = "Salvando...";
            const { error } = await supabaseClient.from('fechamentos').upsert({ 
                data_fechamento: data, total_geral: totalGeral,
                detalhes: todosOsLancamentos, operador_caixa: nomeOperador
            }, { onConflict: 'data_fechamento' });
            if (error) {
                alert("Ocorreu um erro ao salvar o fechamento: " + error.message);
            } else {
                alert(`Fechamento salvo/atualizado com sucesso por ${nomeOperador}!`);
                await carregarHistorico();
            }
            btnSalvar.disabled = false;
            btnSalvar.innerText = "Salvar na Nuvem";
        };

        const carregarHistorico = async () => {
            // ... (lógica de carregar histórico inalterada)
            const { data, error } = await supabaseClient
                .from('fechamentos')
                .select('*')
                .order('data_fechamento', { ascending: false });
            if (error) {
                listaHistoricoDiv.innerHTML = `<p style="color: red;">Erro ao carregar o histórico: ${error.message}</p>`;
                return;
            }
            if (!data || data.length === 0) {
                listaHistoricoDiv.innerHTML = "<p>Nenhum fechamento salvo ainda.</p>"; return;
            }
            listaHistoricoDiv.innerHTML = '';
            data.forEach(item => {
                const dia = new Date(item.data_fechamento + 'T00:00:00').toLocaleDateString('pt-BR');
                const operador = item.operador_caixa || 'N/A';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'historico-item';
                itemDiv.dataset.data = item.data_fechamento;
                itemDiv.innerHTML = `
                    <div class="historico-item-linha1">
                        <span>${dia}</span>
                        <span>${formatarMoeda(item.total_geral)}</span>
                    </div>
                    <div class="historico-item-linha2">Operador(a): ${operador}</div>`;
                listaHistoricoDiv.appendChild(itemDiv);
            });
        };

        const carregarFechamentoDoDia = async (data) => {
            todosOsLancamentos = {};
            formasDePagamento.forEach(forma => atualizarTudo(forma));
            resumoDiv.classList.remove('is-visible');
            const { data: fechamento, error } = await supabaseClient
                .from('fechamentos')
                .select('*')
                .eq('data_fechamento', data)
                .single();
            if (error && error.code !== 'PGRST116') {
                 console.error("Erro ao carregar dia:", error);
            }
            if (fechamento && fechamento.detalhes) {
                todosOsLancamentos = fechamento.detalhes;
                formasDePagamento.forEach(forma => atualizarTudo(forma));
                // OTIMIZAÇÃO: Exibir resumo automaticamente ao carregar um fechamento salvo.
                calcularEExibirResumo();
            }
        };

        const inicializar = async () => {
            const hoje = new Date().toISOString().split('T')[0];
            dataInput.value = hoje;
            gerarCamposDePagamento();
            await carregarHistorico();
            await carregarFechamentoDoDia(hoje);
            dataInput.addEventListener('change', () => carregarFechamentoDoDia(dataInput.value));
            listaHistoricoDiv.addEventListener('click', async (event) => {
                const item = event.target.closest('.historico-item');
                if (item) {
                    dataInput.value = item.dataset.data;
                    await carregarFechamentoDoDia(item.dataset.data);
                }
            });
            btnSalvar.addEventListener('click', salvarFechamento);
            btnResumo.addEventListener('click', calcularEExibirResumo);
            btnLimpar.addEventListener('click', limparTela);
            formasPagamentoDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('btn-lancar')) lancarValor(event.target.dataset.forma);
                if (event.target.classList.contains('remove-lancamento')) removerLancamento(event.target.dataset.forma, parseInt(event.target.dataset.index));
            });
            formasPagamentoDiv.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && event.target.classList.contains('lancamento-field')) {
                    lancarValor(event.target.nextElementSibling.dataset.forma);
                }
            });
        };
        
        inicializar();
    });
    </script>
</body>
</html>
